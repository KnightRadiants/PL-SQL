# Oracle SQL / PL/SQL – szybka ściąga

## Podstawy sesji / schematu

```sql
-- Show current user & schema
SELECT USER FROM DUAL;

-- Switch schema (read-only in Live SQL; for reference)
-- ALTER SESSION SET CURRENT_SCHEMA = OE;
```

### CREATE TABLE

```sql
-- Simple table with identity, PK and FK
CREATE TABLE employees_demo (
  employee_id NUMBER GENERATED BY DEFAULT AS IDENTITY, -- auto-increment (12c+)
  first_name  VARCHAR2(50),
  last_name   VARCHAR2(50) NOT NULL,
  email       VARCHAR2(100) UNIQUE,
  hire_date   DATE DEFAULT SYSDATE,
  department_id NUMBER,
  CONSTRAINT pk_employees_demo PRIMARY KEY (employee_id),
  CONSTRAINT fk_emp_dept_demo FOREIGN KEY (department_id)
    REFERENCES departments(department_id)
);

```

### Alternatywa: SEQUENCE + trigger (starsze wersje)

```sql
-- Sequence
CREATE SEQUENCE emp_seq START WITH 1 INCREMENT BY 1;

-- Trigger to emulate identity
CREATE OR REPLACE TRIGGER trg_emp_bi
BEFORE INSERT ON employees_demo
FOR EACH ROW
WHEN (NEW.employee_id IS NULL)
BEGIN
  :NEW.employee_id := emp_seq.NEXTVAL; -- set id
END;
/

```

### INSERT

```sql
-- Insert with explicit columns
INSERT INTO employees_demo (first_name, last_name, email, department_id)
VALUES ('Alice', 'Smith', 'alice.smith@example.com', 60);

-- Insert multiple rows (use separate INSERTs in Oracle; no multi-values)
INSERT INTO employees_demo (first_name, last_name) VALUES ('Bob','Brown');
INSERT INTO employees_demo (first_name, last_name) VALUES ('Carol','Green');

-- Insert from SELECT
INSERT INTO employees_demo (first_name, last_name, department_id)
SELECT first_name, last_name, department_id
FROM employees
WHERE department_id = 60;
```

### SELECT (filtry, sortowanie, operatory)

```sql
-- Basic projection
SELECT first_name, last_name, salary
FROM employees;

-- WHERE with operators
SELECT *
FROM employees
WHERE salary > 10000                -- comparison
  AND commission_pct IS NOT NULL    -- NULL checks
  AND job_id IN ('IT_PROG','SA_MAN')-- IN list
  AND hire_date BETWEEN DATE '2005-01-01' AND DATE '2007-12-31' -- range
  AND last_name LIKE 'S%';          -- pattern (case-sensitive by default)

-- ORDER BY
SELECT last_name, salary
FROM employees
ORDER BY salary DESC, last_name ASC;

-- DISTINCT
SELECT DISTINCT department_id FROM employees;

-- TOP-N (Oracle)
SELECT *
FROM (
  SELECT e.*, ROW_NUMBER() OVER (ORDER BY salary DESC) AS rn
  FROM employees e
)
WHERE rn <= 10;

```

### JOIN / GROUP BY / HAVING

```sql
-- Join example
SELECT e.last_name, d.department_name, l.city
FROM employees e
JOIN departments d ON d.department_id = e.department_id
JOIN locations   l ON l.location_id   = d.location_id;

-- Aggregation
SELECT department_id, COUNT(*) AS cnt, ROUND(AVG(salary),2) AS avg_sal
FROM employees
GROUP BY department_id
HAVING COUNT(*) >= 5                -- filter on groups
ORDER BY cnt DESC;
```

### UPDATE

```sql
-- Update with condition
UPDATE employees_demo
SET salary = salary * 1.05  -- give a 5% raise
WHERE department_id = 60;
```

### DELETE

```sql
-- Delete with condition
DELETE FROM employees_demo
WHERE last_name = 'Brown';
```

### ALTER TABLE

```sql
-- Add column
ALTER TABLE employees_demo ADD (phone_number VARCHAR2(30));

-- Modify column type / nullability
ALTER TABLE employees_demo MODIFY (last_name VARCHAR2(80) NOT NULL);

-- Rename column
ALTER TABLE employees_demo RENAME COLUMN phone_number TO phone;

-- Add/Drop constraints
ALTER TABLE employees_demo ADD CONSTRAINT uq_emp_email UNIQUE (email);
ALTER TABLE employees_demo DROP CONSTRAINT uq_emp_email;

-- Drop column
ALTER TABLE employees_demo DROP COLUMN email;

-- Rename table
ALTER TABLE employees_demo RENAME TO employees_demo_arch;

```

### DROP

```sql
-- Drop table (with data)
DROP TABLE employees_demo PURGE;

-- Drop sequence / trigger
DROP SEQUENCE emp_seq;
DROP TRIGGER trg_emp_bi;
```

## Typy danych (Oracle)

```sql
VARCHAR2(n)       – variable-length string
CHAR(n)           – fixed-length string
NUMBER(p,s)       – numeric (precision, scale), e.g., NUMBER(10,2)
DATE              – date + time to seconds (no timezone)
TIMESTAMP         – date + time to fractional seconds (no timezone)
TIMESTAMP WITH TIME ZONE
TIMESTAMP WITH LOCAL TIME ZONE
CLOB              – character large object
BLOB              – binary large object
```

### DATE vs TIMESTAMP

* `DATE` – seconds precision, bez strefy czasowej
* `TIMESTAMP` – nanoseconds precision, opcje ze strefą (WITH TIME ZONE, WITH LOCAL TIME ZONE)

### Funkcje i przydatne konstrukcje

```sql
-- COALESCE / NVL
SELECT NVL(commission_pct, 0) AS comm FROM employees;

-- CASE
SELECT last_name,
       CASE WHEN salary >= 15000 THEN 'HIGH'
            WHEN salary >= 8000  THEN 'MID'
            ELSE 'LOW' END AS band
FROM employees;

-- Subquery IN / EXISTS
SELECT employee_id, last_name
FROM employees e
WHERE EXISTS (
  SELECT 1
  FROM orders o
  WHERE o.sales_rep_id = e.employee_id
);
```

